global
    log 127.0.0.1 local0
    log 127.0.0.1 local1 notice
    daemon
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor
    timeout connect 5s
    timeout client  30s
    timeout server  30s

# Frontend: Accepts client HTTP traffic and routes to services
frontend microblog_api
    bind 0.0.0.0:8080

    # Path-based routing
    acl is_posts path_beg /posts
    acl is_likes path_beg /likes
    acl is_polls path_beg /polls
    acl is_user_likes path_reg ^/users/[^/]+/likes(\?.*)?$
    acl is_users path_beg /users
    acl is_login path_beg /login
    acl is_register path_beg /register

    use_backend timelines_service if is_posts
    use_backend likes_service if is_likes or is_user_likes
    use_backend polls_service if is_polls
    use_backend users_service if is_users or is_login or is_register

    # Default to users_service for any other paths
    default_backend users_service

# Backends
backend users_service
    balance roundrobin
    # Single instance of users service
    server users1 127.0.0.1:rs 5100 check

backend timelines_service
    balance roundrobin
    # Three instances of timelines service
    server timelines1 127.0.0.1:5200 check
    server timelines2 127.0.0.1:5201 check
    server timelines3 127.0.0.1:5202 check

backend likes_service
    balance roundrobin
    # Single instance of likes service
    server likes1 127.0.0.1:8004 check

backend polls_service
    balance roundrobin
    # Single instance of polls service
    server polls1 127.0.0.1:8005 check

# Optional: HAProxy stats (uncomment to enable)
#listen stats
#    bind 0.0.0.0:8404
#    stats enable
#    stats uri /stats
#    stats refresh 5s
#    stats auth admin:admin

